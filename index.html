<!DOCTYPE html>

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Nambour Christian College - Alumni Hub</title>
    <link href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

```
    body {
        font-family: 'Lato', sans-serif;
        overflow: hidden;
        background: #ffffff;
    }
    
    #container {
        width: 100vw;
        height: 100vh;
    }
    
    #guideModal {
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.8);
        display: flex;
        align-items: center;
        justify-content: center;
        z-index: 1000;
    }
    
    #guideContent {
        background: white;
        padding: 40px;
        border-radius: 15px;
        max-width: 450px;
        text-align: center;
        box-shadow: 0 10px 40px rgba(0, 0, 0, 0.3);
    }
    
    #guideContent h1 {
        font-size: 28px;
        margin-bottom: 25px;
        color: #006666;
        font-weight: 700;
    }
    
    #guideContent p {
        font-size: 16px;
        line-height: 1.8;
        margin-bottom: 15px;
        color: #333;
        font-weight: 400;
    }
    
    #guideContent .count {
        margin-top: 20px;
        font-size: 14px;
        color: #666;
    }
    
    #closeGuide {
        margin-top: 30px;
        padding: 12px 35px;
        background: #006666;
        color: white;
        border: none;
        border-radius: 25px;
        font-size: 16px;
        cursor: pointer;
        font-family: 'Lato', sans-serif;
        font-weight: 700;
        transition: background 0.3s;
    }
    
    #closeGuide:hover {
        background: #008080;
    }
    
    #alumniInfo {
        position: absolute;
        color: #333;
        background: white;
        padding: 20px;
        border-radius: 12px;
        min-width: 300px;
        max-width: 350px;
        display: none;
        z-index: 100;
        box-shadow: 0 5px 25px rgba(0, 0, 0, 0.3);
        pointer-events: none;
    }
    
    #alumniInfo::before {
        content: '';
        position: absolute;
        width: 0;
        height: 0;
        border-style: solid;
    }
    
    #alumniInfo.arrow-bottom::before {
        bottom: -10px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 10px 10px 0 10px;
        border-color: white transparent transparent transparent;
    }
    
    #alumniInfo.arrow-top::before {
        top: -10px;
        left: 50%;
        transform: translateX(-50%);
        border-width: 0 10px 10px 10px;
        border-color: transparent transparent white transparent;
    }
    
    #alumniInfo.arrow-left::before {
        left: -10px;
        top: 50%;
        transform: translateY(-50%);
        border-width: 10px 10px 10px 0;
        border-color: transparent white transparent transparent;
    }
    
    #alumniInfo.arrow-right::before {
        right: -10px;
        top: 50%;
        transform: translateY(-50%);
        border-width: 10px 0 10px 10px;
        border-color: transparent transparent transparent white;
    }
    
    #alumniInfo h2 {
        font-size: 20px;
        margin-bottom: 8px;
        color: #006666;
        font-weight: 700;
    }
    
    #alumniInfo p {
        font-size: 14px;
        margin: 5px 0;
        font-weight: 400;
        color: #333;
    }
    
    #alumniInfo strong {
        font-weight: 700;
        color: #006666;
    }
    
    #alumniInfo a {
        color: #006666;
        text-decoration: none;
        word-break: break-all;
    }
    
    #alumniInfo a:hover {
        text-decoration: underline;
    }
    
    .loading {
        position: absolute;
        top: 50%;
        left: 50%;
        transform: translate(-50%, -50%);
        color: #333;
        font-size: 24px;
        z-index: 200;
        font-weight: 400;
    }
</style>
```

</head>
<body>
    <div class="loading" id="loading">Loading Earth...</div>

```
<div id="guideModal">
    <div id="guideContent">
        <h1>NCC Alumni Globe</h1>
        <p>üåç Drag to rotate the globe</p>
        <p>üñ±Ô∏è Scroll to zoom in and out</p>
        <p>üìç Click markers for alumni info</p>
        <p class="count"><span id="alumniCount">0</span> alumni worldwide</p>
        <button id="closeGuide">Start Exploring</button>
    </div>
</div>

<div id="alumniInfo"></div>

<div id="container"></div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r128/three.min.js"></script>
<script>
    // Alumni data will be loaded from CSV file
    let alumniData = [];

    let scene, camera, renderer, earth, markers = [];
    let isDragging = false;
    let previousMousePosition = { x: 0, y: 0 };
    let selectedMarker = null;
    let canInteract = false;
    let clusters = [];

    // Load CSV data
    async function loadAlumniData() {
        try {
            const response = await window.fs.readFile('alumni.csv', { encoding: 'utf8' });
            parseCSV(response);
        } catch (error) {
            console.error('Failed to load alumni.csv. Using fallback data.', error);
            document.getElementById('loading').textContent = 'alumni.csv not found. Using sample data.';
            setTimeout(() => {
                useFallbackData();
                document.getElementById('loading').style.display = 'none';
                init();
            }, 2000);
        }
    }

    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        const headers = lines[0].split(',').map(h => h.trim());
        
        for (let i = 1; i < lines.length; i++) {
            const values = lines[i].split(',').map(v => v.trim());
            if (values.length < 4) continue; // Skip invalid rows
            
            const alumni = {
                name: values[0] || '',
                lat: parseFloat(values[1]) || 0,
                lon: parseFloat(values[2]) || 0,
                location: values[3] || '',
                year: values[4] || '',
                career: values[5] || '',
                email: values[6] || '',
                facebook: values[7] || '',
                instagram: values[8] || ''
            };
            
            if (alumni.name && !isNaN(alumni.lat) && !isNaN(alumni.lon)) {
                alumniData.push(alumni);
            }
        }
        
        document.getElementById('alumniCount').textContent = alumniData.length;
        init();
    }

    function useFallbackData() {
        // Fallback sample data if CSV not found
        alumniData = [
            { name: "Sarah Mitchell", lat: -26.6278, lon: 152.9599, location: "Nambour, Australia", year: "2015", career: "Teacher", email: "sarah.m@example.com", facebook: "@sarahmitchell", instagram: "@sarah_mitchell" },
            { name: "James Cooper", lat: -33.8688, lon: 151.2093, location: "Sydney, Australia", year: "2013", career: "Software Engineer", email: "james.c@example.com", facebook: "", instagram: "@jamescooper" },
            { name: "Emma Wilson", lat: -37.8136, lon: 144.9631, location: "Melbourne, Australia", year: "2016", career: "Doctor", email: "emma.w@example.com", facebook: "@emmawilson", instagram: "" },
            { name: "Daniel Brown", lat: -27.4698, lon: 153.0251, location: "Brisbane, Australia", year: "2014", career: "Architect", email: "", facebook: "@danielbrown", instagram: "@dan_brown" },
            { name: "Oliver Harris", lat: 51.5074, lon: -0.1278, location: "London, UK", year: "2012", career: "Financial Analyst", email: "oliver.h@example.com", facebook: "", instagram: "" }
        ];
        document.getElementById('alumniCount').textContent = alumniData.length;
    }

    // Calculate distance between two lat/lon points in degrees
    function getDistance(lat1, lon1, lat2, lon2) {
        return Math.sqrt(Math.pow(lat2 - lat1, 2) + Math.pow(lon2 - lon1, 2));
    }

    // Create clusters of nearby alumni
    function createClusters() {
        clusters = [];
        const processed = new Set();
        const clusterRadius = 1.5; // degrees
        
        alumniData.forEach((alumni, index) => {
            if (processed.has(index)) return;
            
            const cluster = {
                alumni: [alumni],
                indices: [index],
                centerLat: alumni.lat,
                centerLon: alumni.lon
            };
            
            alumniData.forEach((other, otherIndex) => {
                if (otherIndex === index || processed.has(otherIndex)) return;
                
                const dist = getDistance(alumni.lat, alumni.lon, other.lat, other.lon);
                if (dist < clusterRadius) {
                    cluster.alumni.push(other);
                    cluster.indices.push(otherIndex);
                    processed.add(otherIndex);
                }
            });
            
            if (cluster.alumni.length > 1) {
                cluster.centerLat = cluster.alumni.reduce((sum, a) => sum + a.lat, 0) / cluster.alumni.length;
                cluster.centerLon = cluster.alumni.reduce((sum, a) => sum + a.lon, 0) / cluster.alumni.length;
            }
            
            processed.add(index);
            clusters.push(cluster);
        });
    }

    // Update marker positions based on zoom level
    function updateMarkerClustering() {
        const zoomLevel = camera.position.z;
        const spreadThreshold = 2.0;
        
        clusters.forEach((cluster) => {
            if (cluster.alumni.length === 1) {
                const alumni = cluster.alumni[0];
                const marker = markers[cluster.indices[0]];
                const position = latLonToVector3(alumni.lat, alumni.lon, 1.01);
                marker.position.copy(position);
            } else {
                const spreadFactor = Math.max(0, Math.min(1, (spreadThreshold - zoomLevel) / spreadThreshold));
                
                cluster.alumni.forEach((alumni, i) => {
                    const marker = markers[cluster.indices[i]];
                    
                    if (spreadFactor > 0.01) {
                        const clusterPos = latLonToVector3(cluster.centerLat, cluster.centerLon, 1.01);
                        marker.position.copy(clusterPos);
                        
                        const angle = (i / cluster.alumni.length) * Math.PI * 2;
                        const offset = 0.005 * spreadFactor;
                        marker.position.x += Math.cos(angle) * offset;
                        marker.position.y += Math.sin(angle) * offset * 0.5;
                    } else {
                        const position = latLonToVector3(alumni.lat, alumni.lon, 1.01);
                        marker.position.copy(position);
                    }
                });
            }
        });
    }

    // Convert lat/lon to 3D coordinates
    function latLonToVector3(lat, lon, radius) {
        const phi = (90 - lat) * (Math.PI / 180);
        const theta = (lon + 180) * (Math.PI / 180);
        
        const x = -(radius * Math.sin(phi) * Math.cos(theta));
        const z = (radius * Math.sin(phi) * Math.sin(theta));
        const y = (radius * Math.cos(phi));
        
        return new THREE.Vector3(x, y, z);
    }

    // Set initial rotation to view Nambour
    function setInitialViewToNambour() {
        const nambourLat = -26.6313;
        const nambourLon = 152.9604;
        
        const rotationY = -(nambourLon + 180) * (Math.PI / 180);
        const rotationX = (nambourLat) * (Math.PI / 180);
        
        earth.rotation.y = rotationY;
        earth.rotation.x = rotationX;
    }

    function init() {
        scene = new THREE.Scene();
        
        camera = new THREE.PerspectiveCamera(45, window.innerWidth / window.innerHeight, 0.1, 1000);
        camera.position.z = 2.5;
        
        renderer = new THREE.WebGLRenderer({ antialias: true });
        renderer.setSize(window.innerWidth, window.innerHeight);
        renderer.setPixelRatio(Math.min(window.devicePixelRatio, 2));
        document.getElementById('container').appendChild(renderer.domElement);
        
        // Brighter lights
        const ambientLight = new THREE.AmbientLight(0xffffff, 1.2);
        scene.add(ambientLight);
        
        const directionalLight = new THREE.DirectionalLight(0xffffff, 1.5);
        directionalLight.position.set(5, 3, 5);
        scene.add(directionalLight);
        
        const directionalLight2 = new THREE.DirectionalLight(0xffffff, 0.8);
        directionalLight2.position.set(-5, -3, -5);
        scene.add(directionalLight2);
        
        const geometry = new THREE.SphereGeometry(1, 64, 64);
        
        const textureLoader = new THREE.TextureLoader();
        
        textureLoader.load(
            './earth.jpg',
            (texture) => {
                const material = new THREE.MeshPhongMaterial({
                    map: texture,
                    bumpScale: 0.005,
                    shininess: 10,
                    specular: 0x333333
                });
                
                earth = new THREE.Mesh(geometry, material);
                scene.add(earth);
                
                setInitialViewToNambour();
                
                addMarkers();
                document.getElementById('loading').style.display = 'none';
            },
            undefined,
            (error) => {
                console.error('Failed to load earth.jpg', error);
                document.getElementById('loading').textContent = 'Error: earth.jpg not found.';
                
                setTimeout(() => {
                    const material = new THREE.MeshPhongMaterial({
                        color: 0x2171a3,
                        shininess: 10
                    });
                    earth = new THREE.Mesh(geometry, material);
                    scene.add(earth);
                    setInitialViewToNambour();
                    addMarkers();
                    document.getElementById('loading').style.display = 'none';
                }, 2000);
            }
        );
        
        document.getElementById('closeGuide').addEventListener('click', () => {
            document.getElementById('guideModal').style.display = 'none';
            canInteract = true;
        });
        
        renderer.domElement.addEventListener('mousedown', onMouseDown);
        renderer.domElement.addEventListener('mousemove', onMouseMove);
        renderer.domElement.addEventListener('mouseup', onMouseUp);
        renderer.domElement.addEventListener('wheel', onWheel);
        renderer.domElement.addEventListener('click', onClick);
        
        renderer.domElement.addEventListener('touchstart', onTouchStart);
        renderer.domElement.addEventListener('touchmove', onTouchMove);
        renderer.domElement.addEventListener('touchend', onTouchEnd);
        
        window.addEventListener('resize', onWindowResize);
        
        animate();
    }

    function addMarkers() {
        createClusters();
        
        alumniData.forEach(alumni => {
            const position = latLonToVector3(alumni.lat, alumni.lon, 1.01);
            
            const markerGeometry = new THREE.SphereGeometry(0.02, 16, 16);
            const markerMaterial = new THREE.MeshStandardMaterial({ 
                color: 0x006666,
                emissive: 0x008080,
                emissiveIntensity: 0.5,
                metalness: 0.3,
                roughness: 0.4
            });
            const marker = new THREE.Mesh(markerGeometry, markerMaterial);
            marker.position.copy(position);
            marker.userData = alumni;
            
            earth.add(marker);
            markers.push(marker);
        });
        
        updateMarkerClustering();
    }

    function onMouseDown(e) {
        if (!canInteract) return;
        isDragging = true;
        previousMousePosition = { x: e.clientX, y: e.clientY };
    }

    function onMouseMove(e) {
        if (!canInteract) return;
        if (isDragging && earth) {
            const deltaX = e.clientX - previousMousePosition.x;
            const deltaY = e.clientY - previousMousePosition.y;
            
            earth.rotation.y += deltaX * 0.005;
            earth.rotation.x += deltaY * 0.005;
            
            previousMousePosition = { x: e.clientX, y: e.clientY };
            
            hideAlumniInfo();
        }
    }

    function onMouseUp() {
        isDragging = false;
    }

    function onTouchStart(e) {
        if (!canInteract) return;
        if (e.touches.length === 1) {
            isDragging = true;
            previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
        }
    }

    function onTouchMove(e) {
        if (!canInteract) return;
        if (isDragging && e.touches.length === 1 && earth) {
            const deltaX = e.touches[0].clientX - previousMousePosition.x;
            const deltaY = e.touches[0].clientY - previousMousePosition.y;
            
            earth.rotation.y += deltaX * 0.005;
            earth.rotation.x += deltaY * 0.005;
            
            previousMousePosition = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            hideAlumniInfo();
        }
    }

    function onTouchEnd() {
        isDragging = false;
    }

    function onWheel(e) {
        if (!canInteract) return;
        e.preventDefault();
        
        const zoomLevel = camera.position.z;
        const zoomSpeed = 0.0008 * zoomLevel;
        
        camera.position.z += e.deltaY * zoomSpeed;
        camera.position.z = Math.max(1.2, Math.min(5, camera.position.z));
        
        updateMarkerClustering();
    }

    function onClick(e) {
        if (!canInteract || isDragging) return;
        
        const mouse = new THREE.Vector2();
        mouse.x = (e.clientX / window.innerWidth) * 2 - 1;
        mouse.y = -(e.clientY / window.innerHeight) * 2 + 1;
        
        const raycaster = new THREE.Raycaster();
        raycaster.setFromCamera(mouse, camera);
        
        const intersects = raycaster.intersectObjects(markers);
        
        if (intersects.length > 0) {
            const alumni = intersects[0].object.userData;
            const marker = intersects[0].object;
            showAlumniInfo(alumni, marker, e.clientX, e.clientY);
        } else {
            hideAlumniInfo();
        }
    }

    function showAlumniInfo(alumni, marker, mouseX, mouseY) {
        const infoDiv = document.getElementById('alumniInfo');
        
        let html = `
            <h2>${alumni.name}</h2>
            ${alumni.year ? `<p><strong>Class of ${alumni.year}</strong></p>` : ''}
            <p>üìç ${alumni.location}</p>
            ${alumni.career ? `<p>üíº ${alumni.career}</p>` : ''}
        `;
        
        if (alumni.email) {
            html += `<p>‚úâÔ∏è <a href="mailto:${alumni.email}">${alumni.email}</a></p>`;
        }
        if (alumni.facebook) {
            html += `<p>üìò <a href="https://facebook.com/${alumni.facebook.replace('@', '')}" target="_blank">${alumni.facebook}</a></p>`;
        }
        if (alumni.instagram) {
            html += `<p>üì∑ <a href="https://instagram.com/${alumni.instagram.replace('@', '')}" target="_blank">${alumni.instagram}</a></p>`;
        }
        
        infoDiv.innerHTML = html;
        
        const markerScreenPos = getScreenPosition(marker);
        
        infoDiv.className = '';
        
        const windowWidth = window.innerWidth;
        const windowHeight = window.innerHeight;
        const popupWidth = 300;
        const popupHeight = 200;
        const offset = 30;
        
        let left = markerScreenPos.x;
        let top = markerScreenPos.y - popupHeight - offset;
        let arrowClass = 'arrow-bottom';
        
        if (top < 10) {
            top = markerScreenPos.y + offset;
            arrowClass = 'arrow-top';
        }
        
        if (left + popupWidth / 2 > windowWidth - 10) {
            left = windowWidth - popupWidth - 10;
            arrowClass = 'arrow-right';
            top = markerScreenPos.y - popupHeight / 2;
        }
        
        if (left - popupWidth / 2 < 10) {
            left = 10;
            arrowClass = 'arrow-left';
            top = markerScreenPos.y - popupHeight / 2;
        } else {
            left = left - popupWidth / 2;
        }
        
        infoDiv.style.left = `${left}px`;
        infoDiv.style.top = `${top}px`;
        infoDiv.className = arrowClass;
        infoDiv.style.display = 'block';
    }

    function getScreenPosition(marker) {
        const vector = new THREE.Vector3();
        marker.getWorldPosition(vector);
        vector.project(camera);
        
        return {
            x: (vector.x * 0.5 + 0.5) * window.innerWidth,
            y: (-vector.y * 0.5 + 0.5) * window.innerHeight
        };
    }

    function hideAlumniInfo() {
        document.getElementById('alumniInfo').style.display = 'none';
    }

    function onWindowResize() {
        camera.aspect = window.innerWidth / window.innerHeight;
        camera.updateProjectionMatrix();
        renderer.setSize(window.innerWidth, window.innerHeight);
    }

    function animate() {
        requestAnimationFrame(animate);
        // NO auto-rotation - user controls only
        renderer.render(scene, camera);
    }

    // Start by loading alumni data
    loadAlumniData();
</script>
```

</body>
</html>
